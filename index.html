<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é˜²è­·åŒ…æ•´ç†è¨ˆç®—æ©Ÿ v1.5</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", "Noto Sans TC", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f4f6f8;
      color: #1f2933;
    }

    /* ===== CREAT æ·±è— Header ===== */
    .creat-header {
      width: 100%;
      background: #0f1e3b; /* æ·±è— */
      color: white;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }

    .creat-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .creat-logo {
      height: 60px;
      width: 60px;
      object-fit: cover;
      background: none;
      padding: 4px;
      border-radius: 50%;
      border: none;
    }

    .creat-header-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .creat-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      line-height: 1.2;
    }

    .creat-maker {
      font-size: 14px;
      font-weight: 600;
    }

    .creat-role {
      font-size: 11px;
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .creat-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 16px;
      }

      .creat-header-right {
        align-items: flex-start;
      }

      .creat-header-title {
        font-size: 18px;
      }

      .creat-logo {
        height: 48px;
      }
    }

    /* ===== ä¸»å…§å®¹å€æ¨£å¼ ===== */
    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 24px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    h1 {
      font-size: 24px;
      margin-top: 0;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .section {
      margin-bottom: 20px;
      padding: 12px 16px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
    }

    .section-note {
      font-size: 12px;
      color: #6b7280;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #374151;
    }

    input, select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .grid {
      display: grid;
      gap: 12px 16px;
    }

    .plan-table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: white;
    }

    thead {
      background: #e5e7eb;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 12px;
      color: #374151;
    }

    tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      border: none;
      cursor: pointer;
      gap: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    .btn + .btn {
      margin-left: 8px;
    }

    .btn-icon {
      font-size: 14px;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .output-table {
      margin-top: 8px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 8px;
    }

    .empty-text {
      font-size: 13px;
      color: #9ca3af;
      padding: 4px 0 6px;
    }

    .history-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .small-text {
      font-size: 11px;
      color: #6b7280;
    }

    .history-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      overflow: hidden;
    }

    .history-card-header {
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: #f3f4f6;
    }

    .history-header-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-title-line {
      font-size: 13px;
      font-weight: 600;
    }

    .history-sub-line {
      font-size: 11px;
      color: #6b7280;
    }

    .history-toggle-icon {
      font-size: 16px;
      margin-left: 8px;
    }

    .history-card-body {
      display: none;
      padding: 10px 12px 12px;
      font-size: 12px;
    }

    .history-section-title {
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .history-mini-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 11px;
    }

    .history-mini-table th,
    .history-mini-table td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      white-space: nowrap;
    }

    .history-mini-table th {
      background: #f9fafb;
      font-weight: 600;
    }

    .history-mini-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    @media (max-width: 768px) {
      .container {
        margin: 8px;
        padding: 16px;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 4px 6px;
      }

      .grid {
        grid-template-columns: 1fr !important;
      }

	/* æŒ‰éˆ•å…§çš„ SVG icon å…±ç”¨è¨­å®š */
.btn svg {
  margin-right: 6px;
  display: inline-block;
  vertical-align: middle;
}

/* ä¸»æŒ‰éˆ•ï¼ˆè—åº•ï¼‰â†’ ç™½è‰² icon */
.btn-primary svg {
  stroke: #ffffff;
  fill: none;
}

/* æ¬¡æŒ‰éˆ•ï¼ˆç°åº•ï¼‰â†’ å“ç‰Œæ·±è— icon */
.btn-secondary svg {
  stroke: #0f1e3b;   /* èˆ‡ Header å®Œå…¨åŒè‰² */
  fill: none;
}

    }


  </style>
</head>
<body>

<!-- CREAT æ·±è—å“ç‰Œ Header -->
<header class="creat-header">
  <div class="creat-header-left">

    <!-- ä½ çš„å€‹äººå“ç‰Œ LOGO -->
    <img src="Profile-LOGO.png" alt="Personal Logo" class="creat-logo">

    <div>
      <div class="creat-header-title">é‹å‹•è²¼ç´®è€—æä¼°ç®—å™¨</div>
      <div class="creat-role" style="margin-top:2px;">Personal Athletic Training Utility</div>
    </div>
  </div>

  <div class="creat-header-right">
    <div class="creat-maker">è£½ä½œè€…ï½œå¼µé›…å©·</div>
    <div class="creat-role">NTNU Athletic Trainer</div>
  </div>
</header>


<div class="container">
  <div class="subtitle">
    è¼¸å…¥è²¼ç´®æ–¹å¼ã€é¸æ‰‹äººæ•¸èˆ‡æ¯”è³½å ´æ¬¡ï¼Œç³»çµ±æœƒå¹«ä½ ä¼°ç®—æ¯ç¨®è²¼å¸ƒéœ€è¦æº–å‚™çš„å·æ•¸ï¼Œä¸¦å¯å„²å­˜æ­·å²ç´€éŒ„æ–¹ä¾¿è¿½è¹¤ã€‚
  </div>

  <!-- æ¯”è³½åŸºæœ¬è³‡è¨Š -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">æ¯”è³½åŸºæœ¬è³‡è¨Š</div>
      <div class="section-note">é€™äº›è³‡è¨Šæœƒä¸€èµ·ä¿å­˜åˆ°æ­·å²ç´€éŒ„ä¸­</div>
    </div>

    <div class="grid" style="grid-template-columns: 2fr 1fr 1.2fr;">
      <div>
        <label for="eventName">æ´»å‹•åç¨±</label>
        <input id="eventName" type="text" placeholder="ä¾‹å¦‚ï¼š113 å­¸å¹´åº¦ UBA è¤‡è³½">
      </div>
      <div>
        <label for="eventLocation">æ¯”è³½åœ°é»</label>
        <input id="eventLocation" type="text" placeholder="ä¾‹å¦‚ï¼šå°åŒ—é«”è‚²é¤¨">
      </div>
      <div>
        <label>æ¯”è³½æ—¥æœŸï¼ˆèµ·è¨–ï¼‰</label>
        <div style="display:flex; gap:6px;">
          <input id="eventStartDate" type="date" style="flex:1;">
          <input id="eventEndDate" type="date" style="flex:1;">
        </div>
      </div>
    </div>
  </div>

  <!-- è²¼ç´®è¨ˆç•« -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">è²¼ç´®è¨ˆç•«</div>
      <div class="section-note">
        æ¯ä¸€åˆ—ä»£è¡¨ã€ŒæŸç¨®è²¼ç´®ï¼‹æŸä¸€ç¨®è²¼å¸ƒã€ã€‚è‹¥åŒä¸€ç¨®è²¼ç´®éœ€è¦å¤šç¨®è²¼å¸ƒï¼Œå¯æ–°å¢å¤šåˆ—ï¼Œè²¼ç´®åç¨±å¡«ä¸€æ¨£ã€è²¼å¸ƒç¨®é¡é¸ä¸åŒã€‚
      </div>
    </div>

    <div class="plan-table-wrapper">
      <table id="planTable">
        <thead>
        <tr>
          <th>è²¼ç´®åç¨±</th>
          <th>è²¼å¸ƒç¨®é¡</th>
          <th>æ¯æ¬¡ç´„ç”¨å¹¾å·</th>
          <th>é‹å‹•å“¡äººæ•¸</th>
          <th>æ¯äººæ¯å ´æ¬¡è²¼å¹¾æ¬¡</th>
          <th>æ¯”è³½å ´æ¬¡</th>
          <th>åˆªé™¤</th>
        </tr>
        </thead>
        <tbody id="planTableBody">
        <!-- JS ç”¢ç”Ÿ -->
        </tbody>
      </table>
    </div>

    <div class="actions-row">
      <button class="btn btn-secondary" id="addRowBtn">
        <span class="btn-icon">ï¼‹</span> æ–°å¢è²¼ç´®æ–¹å¼
      </button>
    </div>
  </div>

  <!-- è¨ˆç®—çµæœ -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">è¨ˆç®—çµæœ</div>
      <div class="section-note">ä¾è²¼å¸ƒç¨®é¡å½™ç¸½ï¼Œæ•¸é‡å·²è‡ªå‹•é€²ä½ï¼ˆå‘ä¸Šå–æ•´æ•¸å·ï¼‰</div>
    </div>

    <!-- å®‰å…¨ç·©è¡è¨­å®š -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div style="font-size:12px; color:#4b5563;">
        å®‰å…¨ç·©è¡ï¼šåœ¨è¨ˆç®—çµæœä¸Šé¡å¤–å¢åŠ ä¸€å®šç™¾åˆ†æ¯”çš„å‚™æ–™é‡ï¼ˆä¾‹å¦‚ 10%ï¼‰ã€‚
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <label for="bufferPercent" style="margin:0; font-size:13px;">å®‰å…¨ç·©è¡(%)</label>
        <input id="bufferPercent" type="number" min="0" step="1" value="10" style="width:80px;">
      </div>
    </div>

    <div class="actions-row">

  <!-- è¨ˆç®—è€—æï¼ˆç™½è‰² iconï¼‰ -->
  <button class="btn btn-primary" id="calculateBtn">
    <svg width="14" height="14" viewBox="0 0 24 24"
         xmlns="http://www.w3.org/2000/svg"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <!-- å°è¨ˆç®—æ©Ÿ icon -->
      <rect x="3" y="3" width="18" height="18" rx="2"></rect>
      <line x1="8" y1="7" x2="16" y2="7"></line>
      <line x1="8" y1="11" x2="8" y2="11"></line>
      <line x1="12" y1="11" x2="12" y2="11"></line>
      <line x1="16" y1="11" x2="16" y2="11"></line>
      <line x1="8" y1="15" x2="8" y2="15"></line>
      <line x1="12" y1="15" x2="12" y2="15"></line>
      <line x1="16" y1="15" x2="16" y2="15"></line>
    </svg>
    è¨ˆç®—è€—æ
  </button>

  <!-- å„²å­˜ç´€éŒ„ï¼ˆå“ç‰Œæ·±è— iconï¼‰ -->
  <button class="btn btn-secondary" id="saveHistoryBtn">
    <svg width="14" height="14" viewBox="0 0 24 24"
         xmlns="http://www.w3.org/2000/svg"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <!-- save icon -->
      <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
      <polyline points="17 21 17 13 7 13 7 21"></polyline>
      <polyline points="7 3 7 8 15 8"></polyline>
    </svg>
    å„²å­˜ç´€éŒ„
  </button>

</div>


    <div id="outputArea">
      <div class="empty-text" id="noOutputText">å°šæœªç”¢ç”Ÿè¨ˆç®—çµæœï¼Œè«‹å…ˆé»é¸ã€Œè¨ˆç®—å·æ•¸ã€ã€‚</div>
      <div class="output-table" id="outputTableWrapper" style="display:none;">
        <table id="outputTable">
          <thead>
          <tr>
            <th>è²¼å¸ƒç¨®é¡</th>
            <th>ä¼°è¨ˆéœ€è¦å·æ•¸ï¼ˆå«å®‰å…¨ç·©è¡ï¼‰</th>
          </tr>
          </thead>
          <tbody id="outputTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- æ­·å²ç´€éŒ„ -->
  <div class="section">
    <div class="history-header-row">
      <div class="section-title">
        æ­·å²ç´€éŒ„
        <span class="tag">åƒ…å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨</span>
      </div>
      <button class="btn btn-danger" id="clearHistoryBtn">
        <span class="btn-icon">ğŸ—‘</span> æ¸…é™¤æ‰€æœ‰æ­·å²
      </button>
    </div>
    <div class="small-text">
      é»æ“Šå¡ç‰‡å¯ä»¥å±•é–‹è©³ç´°å…§å®¹ï¼Œä¹Ÿå¯ä»¥ä¸€éµæŠŠç•¶æ™‚çš„è¨­å®šå¥—ç”¨å›ä¸Šæ–¹è¡¨å–®ã€‚
    </div>

    <div id="historyArea">
      <div class="empty-text" id="noHistoryText">ç›®å‰æ²’æœ‰ä»»ä½•æ­·å²ç´€éŒ„ã€‚</div>
      <div class="history-list" id="historyList" style="display:none;">
        <!-- JS ç”¢ç”Ÿå¡ç‰‡ -->
      </div>
    </div>
  </div>
</div>

<script>
  const TAPE_TYPES = [
    "è•¾çµ²å¢Š",
    "çš®è†šè†œ",
    "ç™½è²¼-1.5å‹",
    "é‡å½ˆ-3å‹",
    "é‡å½ˆ-2å‹",
    "è¼•å½ˆ-2å‹",
    "è¼•å½ˆ-1.5å‹",
    "è¼•å½ˆ-1å‹",
    "è‚Œè²¼",
    "è†šè‰²å‹•æ…‹è²¼å¸ƒ-å°",
    "è†šè‰²å‹•æ…‹è²¼å¸ƒ-å¤§",
    "Echoå‹•æ…‹è²¼å¸ƒ-å°",
    "Echoå‹•æ…‹è²¼å¸ƒ-å¤§",
    "é›·å¯è¦†è“‹è²¼å¸ƒ",
    "é›·å¯",
    "è‡ªé»è²¼å¸ƒ",
    "æ³¡æ£‰è»Ÿå¢Š",
    "å…¶ä»–"
  ];

  const STORAGE_KEY = "tapeUsageHistory_v1_5";
  let historyData = [];

  function createSelect(options, value) {
    const select = document.createElement("select");
    options.forEach(opt => {
      const option = document.createElement("option");
      option.value = opt;
      option.textContent = opt;
      if (opt === value) option.selected = true;
      select.appendChild(option);
    });
    return select;
  }

  function addPlanRow(defaultData = {}) {
    const tbody = document.getElementById("planTableBody");
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "ä¾‹å¦‚ï¼šè¸é—œç¯€è²¼ç´®";
    nameInput.value = defaultData.name || "";
    tdName.appendChild(nameInput);

    const tdType = document.createElement("td");
    const typeSelect = createSelect(TAPE_TYPES, defaultData.type || TAPE_TYPES[0]);
    tdType.appendChild(typeSelect);

    const tdRollPer = document.createElement("td");
    const rollInput = document.createElement("input");
    rollInput.type = "number";
    rollInput.min = "0";
    rollInput.step = "0.05";
    rollInput.placeholder = "ä¾‹å¦‚ï¼š0.30";
    rollInput.value = defaultData.rollsPerUse != null ? defaultData.rollsPerUse : "";
    tdRollPer.appendChild(rollInput);

    const tdAthletes = document.createElement("td");
    const athletesInput = document.createElement("input");
    athletesInput.type = "number";
    athletesInput.min = "0";
    athletesInput.step = "1";
    athletesInput.placeholder = "ä¾‹å¦‚ï¼š8";
    athletesInput.value = defaultData.athletes != null ? defaultData.athletes : "";
    tdAthletes.appendChild(athletesInput);

    const tdTimes = document.createElement("td");
    const timesInput = document.createElement("input");
    timesInput.type = "number";
    timesInput.min = "0";
    timesInput.step = "1";
    timesInput.placeholder = "é€šå¸¸ç‚º 1";
    timesInput.value = defaultData.timesPerGame != null ? defaultData.timesPerGame : "1";
    tdTimes.appendChild(timesInput);

    const tdGames = document.createElement("td");
    const gamesInput = document.createElement("input");
    gamesInput.type = "number";
    gamesInput.min = "0";
    gamesInput.step = "1";
    gamesInput.placeholder = "ä¾‹å¦‚ï¼š3";
    gamesInput.value = defaultData.games != null ? defaultData.games : "";
    tdGames.appendChild(gamesInput);

    const tdDelete = document.createElement("td");
    const delBtn = document.createElement("button");
    delBtn.className = "btn btn-danger";
    delBtn.type = "button";
    delBtn.innerHTML = '<span class="btn-icon">âœ•</span>';
    delBtn.addEventListener("click", () => {
      tr.remove();
    });
    tdDelete.appendChild(delBtn);

    tr.appendChild(tdName);
    tr.appendChild(tdType);
    tr.appendChild(tdRollPer);
    tr.appendChild(tdAthletes);
    tr.appendChild(tdTimes);
    tr.appendChild(tdGames);
    tr.appendChild(tdDelete);

    tbody.appendChild(tr);
  }

  function getPlanRows() {
    const rows = [];
    const tbody = document.getElementById("planTableBody");
    Array.from(tbody.rows).forEach(tr => {
      const [nameTd, typeTd, rollTd, athletesTd, timesTd, gamesTd] = tr.cells;
      const name = nameTd.querySelector("input").value.trim();
      const type = typeTd.querySelector("select").value;
      const rollsPerUse = parseFloat(rollTd.querySelector("input").value);
      const athletes = parseInt(athletesTd.querySelector("input").value, 10);
      const timesPerGame = parseInt(timesTd.querySelector("input").value, 10);
      const games = parseInt(gamesTd.querySelector("input").value, 10);

      if (!name && (isNaN(rollsPerUse) || isNaN(athletes) || isNaN(timesPerGame) || isNaN(games))) {
        return;
      }

      rows.push({
        name: name || "(æœªå‘½åè²¼ç´®)",
        type,
        rollsPerUse: isNaN(rollsPerUse) ? 0 : rollsPerUse,
        athletes: isNaN(athletes) ? 0 : athletes,
        timesPerGame: isNaN(timesPerGame) ? 0 : timesPerGame,
        games: isNaN(games) ? 0 : games
      });
    });
    return rows;
  }

  function getBufferPercent() {
    const input = document.getElementById("bufferPercent");
    if (!input) return 0;
    const val = parseFloat(input.value);
    if (isNaN(val) || val < 0) return 0;
    return val;
  }

  function summarizeUsage(rows, bufferPercent) {
    const byTapeTypeBase = {};
    rows.forEach(row => {
      const base = row.rollsPerUse * row.athletes * row.timesPerGame * row.games;
      if (!byTapeTypeBase[row.type]) {
        byTapeTypeBase[row.type] = 0;
      }
      byTapeTypeBase[row.type] += base;
    });

    const byTapeType = {};
    const factor = 1 + (bufferPercent || 0) / 100;
    Object.keys(byTapeTypeBase).forEach(type => {
      byTapeType[type] = Math.ceil(byTapeTypeBase[type] * factor);
    });

    return { byTapeType };
  }

  function renderOutput(byTapeType) {
    const noOutputText = document.getElementById("noOutputText");
    const wrapper = document.getElementById("outputTableWrapper");
    const tbody = document.getElementById("outputTableBody");

    tbody.innerHTML = "";

    const types = Object.keys(byTapeType);
    if (!types.length) {
      noOutputText.style.display = "block";
      wrapper.style.display = "none";
      return;
    }

    types.forEach(type => {
      const tr = document.createElement("tr");
      const tdType = document.createElement("td");
      tdType.textContent = type;

      const tdQty = document.createElement("td");
      tdQty.textContent = byTapeType[type] + " å·";

      tr.appendChild(tdType);
      tr.appendChild(tdQty);
      tbody.appendChild(tr);
    });

    noOutputText.style.display = "none";
    wrapper.style.display = "block";
  }

  function calculateAndRender() {
    const rows = getPlanRows();
    const bufferPercent = getBufferPercent();
    const { byTapeType } = summarizeUsage(rows, bufferPercent);
    renderOutput(byTapeType);
    return byTapeType;
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      historyData = raw ? JSON.parse(raw) : [];
    } catch (e) {
      historyData = [];
    }
    renderHistory();
  }

  function saveHistory() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
  }

  function buildTapeSummaryText(byTapeType) {
    const types = Object.keys(byTapeType || {});
    if (!types.length) return "å°šç„¡è²¼å¸ƒç”¨é‡è³‡æ–™";
    const parts = types.slice(0, 3).map(t => `${t} ${byTapeType[t]}å·`);
    if (types.length > 3) parts.push(`â€¦å…± ${types.length} ç¨®è²¼å¸ƒ`);
    return parts.join("ã€");
  }

  function applyRecordToForm(record) {
    document.getElementById("eventName").value = record.eventName || "";
    document.getElementById("eventLocation").value = record.eventLocation || "";
    const startEnd = (record.dateRange || "").split(" è‡³ ");
    document.getElementById("eventStartDate").value = startEnd[0] || "";
    document.getElementById("eventEndDate").value = startEnd[1] || "";
    document.getElementById("bufferPercent").value =
      record.bufferPercent != null ? record.bufferPercent : 10;

    const tbody = document.getElementById("planTableBody");
    tbody.innerHTML = "";
    (record.rows || []).forEach(r => addPlanRow(r));

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function renderHistory() {
    const noHistoryText = document.getElementById("noHistoryText");
    const list = document.getElementById("historyList");

    list.innerHTML = "";

    if (!historyData.length) {
      noHistoryText.style.display = "block";
      list.style.display = "none";
      return;
    }

    historyData.slice().reverse().forEach(item => {
      const card = document.createElement("div");
      card.className = "history-card";

      const header = document.createElement("div");
      header.className = "history-card-header";

      const headerMain = document.createElement("div");
      headerMain.className = "history-header-main";

      const titleLine = document.createElement("div");
      titleLine.className = "history-title-line";
      const dateText = item.dateRange || "-";
      const eventText = item.eventName || "(æœªå‘½åæ´»å‹•)";
      const locationText = item.eventLocation || "";
      titleLine.textContent = `${dateText} ï½œ ${eventText}${locationText ? " ï½œ " + locationText : ""}`;

      const subLine = document.createElement("div");
      subLine.className = "history-sub-line";
      const bufferPercent = item.bufferPercent != null ? item.bufferPercent : 0;
      subLine.textContent =
        buildTapeSummaryText(item.byTapeType || {}) +
        (bufferPercent > 0 ? `ï¼ˆå«å®‰å…¨ç·©è¡ ${bufferPercent}%ï¼‰` : "");

      headerMain.appendChild(titleLine);
      headerMain.appendChild(subLine);

      const toggleIcon = document.createElement("div");
      toggleIcon.className = "history-toggle-icon";
      toggleIcon.textContent = "ï¼‹";

      header.appendChild(headerMain);
      header.appendChild(toggleIcon);

      const body = document.createElement("div");
      body.className = "history-card-body";

      const infoTitle = document.createElement("div");
      infoTitle.className = "history-section-title";
      infoTitle.textContent = "æ´»å‹•è³‡è¨Š";
      body.appendChild(infoTitle);

      const infoText = document.createElement("div");
      infoText.style.fontSize = "11px";
      infoText.style.color = "#4b5563";
      infoText.innerHTML =
        `æ´»å‹•åç¨±ï¼š${eventText || "-"}<br>` +
        `æ¯”è³½åœ°é»ï¼š${locationText || "-"}<br>` +
        `æ—¥æœŸï¼š${dateText || "-"}<br>` +
        `å®‰å…¨ç·©è¡ï¼š${bufferPercent || 0}%`;
      body.appendChild(infoText);

      const detailTitle = document.createElement("div");
      detailTitle.className = "history-section-title";
      detailTitle.style.marginTop = "10px";
      detailTitle.textContent = "è²¼ç´®è©³ç´°åˆ—è¡¨";
      body.appendChild(detailTitle);

      const detailTable = document.createElement("table");
      detailTable.className = "history-mini-table";

      const dtHead = document.createElement("thead");
      dtHead.innerHTML =
        "<tr>" +
        "<th>è²¼ç´®åç¨±</th>" +
        "<th>è²¼å¸ƒç¨®é¡</th>" +
        "<th>æ¯æ¬¡ç”¨é‡(å·)</th>" +
        "<th>äººæ•¸</th>" +
        "<th>æ¯äººæ¯å ´æ¬¡</th>" +
        "<th>å ´æ¬¡</th>" +
        "<th>ä¼°è¨ˆç¸½å·æ•¸ï¼ˆæœªåŠ ç·©è¡ï¼‰</th>" +
        "</tr>";
      detailTable.appendChild(dtHead);

      const dtBody = document.createElement("tbody");
      (item.rows || []).forEach(r => {
        const tr = document.createElement("tr");
        const totalRolls = r.rollsPerUse * r.athletes * r.timesPerGame * r.games;
        tr.innerHTML =
          `<td>${r.name}</td>` +
          `<td>${r.type}</td>` +
          `<td>${r.rollsPerUse || 0}</td>` +
          `<td>${r.athletes || 0}</td>` +
          `<td>${r.timesPerGame || 0}</td>` +
          `<td>${r.games || 0}</td>` +
          `<td>${totalRolls.toFixed(2)}</td>`;
        dtBody.appendChild(tr);
      });
      detailTable.appendChild(dtBody);
      body.appendChild(detailTable);

      const sumTitle = document.createElement("div");
      sumTitle.className = "history-section-title";
      sumTitle.style.marginTop = "10px";
      sumTitle.textContent = "è²¼å¸ƒå½™ç¸½ï¼ˆå«å®‰å…¨ç·©è¡ï¼‰";
      body.appendChild(sumTitle);

      const sumTable = document.createElement("table");
      sumTable.className = "history-mini-table";

      const stHead = document.createElement("thead");
      stHead.innerHTML = "<tr><th>è²¼å¸ƒç¨®é¡</th><th>ä¼°è¨ˆéœ€è¦å·æ•¸</th></tr>";
      sumTable.appendChild(stHead);

      const stBody = document.createElement("tbody");
      Object.keys(item.byTapeType || {}).forEach(type => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${type}</td><td>${item.byTapeType[type]} å·</td>`;
        stBody.appendChild(tr);
      });
      sumTable.appendChild(stBody);
      body.appendChild(sumTable);

      const btnRow = document.createElement("div");
      btnRow.style.marginTop = "8px";
      btnRow.style.display = "flex";
      btnRow.style.justifyContent = "flex-end";
      const applyBtn = document.createElement("button");
      applyBtn.className = "btn btn-secondary";
      applyBtn.type = "button";
      applyBtn.textContent = "å¥—ç”¨é€™ç­†è¨­å®šåˆ°ä¸Šæ–¹è¡¨å–®";
      applyBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        applyRecordToForm(item);
      });
      btnRow.appendChild(applyBtn);
      body.appendChild(btnRow);

      header.addEventListener("click", () => {
        const isOpen = body.style.display === "block";
        body.style.display = isOpen ? "none" : "block";
        toggleIcon.textContent = isOpen ? "ï¼‹" : "ï¼";
      });

      card.appendChild(header);
      card.appendChild(body);
      list.appendChild(card);
    });

    noHistoryText.style.display = "none";
    list.style.display = "flex";
  }

  function saveCurrentToHistory() {
    const eventName = document.getElementById("eventName").value.trim();
    const eventLocation = document.getElementById("eventLocation").value.trim();
    const startDate = document.getElementById("eventStartDate").value;
    const endDate = document.getElementById("eventEndDate").value;

    const rows = getPlanRows();
    if (!rows.length) {
      alert("è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€åˆ—è²¼ç´®è³‡æ–™ã€‚");
      return;
    }

    const bufferPercent = getBufferPercent();
    const { byTapeType } = summarizeUsage(rows, bufferPercent);
    if (!Object.keys(byTapeType).length) {
      alert("ç›®å‰è³‡æ–™ç„¡æ³•è¨ˆç®—å‡ºè€—æé‡ï¼Œè«‹ç¢ºèªå„æ¬„ä½æ˜¯å¦æœ‰å¡«å¯«ã€‚");
      return;
    }

    let dateRange = "";
    if (startDate && endDate) {
      dateRange = `${startDate} è‡³ ${endDate}`;
    } else {
      dateRange = startDate || endDate || "";
    }

    const record = {
      id: Date.now(),
      dateRange,
      eventName: eventName || "",
      eventLocation: eventLocation || "",
      rows,
      byTapeType,
      bufferPercent
    };

    historyData.push(record);
    saveHistory();
    renderHistory();
    renderOutput(byTapeType);
    alert("å·²å„²å­˜åˆ°æ­·å²ç´€éŒ„ï¼");
  }

  function clearHistory() {
    if (!historyData.length) return;
    const ok = confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚");
    if (!ok) return;
    historyData = [];
    saveHistory();
    renderHistory();
  }

  document.addEventListener("DOMContentLoaded", () => {
    addPlanRow({
      name: "è¸é—œç¯€è²¼ç´®",
      type: "ç™½è²¼-1.5å‹",
      rollsPerUse: 0.3,
      athletes: 8,
      timesPerGame: 1,
      games: 3
    });

    document.getElementById("addRowBtn").addEventListener("click", () => addPlanRow());
    document.getElementById("calculateBtn").addEventListener("click", calculateAndRender);
    document.getElementById("saveHistoryBtn").addEventListener("click", saveCurrentToHistory);
    document.getElementById("clearHistoryBtn").addEventListener("click", clearHistory);

    loadHistory();
  });
</script>

</body>
</html>
